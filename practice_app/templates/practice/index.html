{% extends "base.html" %}
{% block title %}ä¸­é†«äº”å€è¾¨è­˜ç·´ç¿’{% endblock %}

{% block content %}
<div class="card">
  <h1>ä¸­é†«äº”å€è¾¨è­˜ç·´ç¿’</h1>
  <p class="muted">æ­¥é©Ÿï¼šé–‹å•Ÿç›¸æ©Ÿæ‹ç…§ â†’ ç³»çµ±èˆ‡ä½ çš„è§€å¯Ÿä¸€èµ·æ¯”å° â†’ é¡¯ç¤ºäº”å€çµæœã€‚</p>

  <!-- ç›¸æ©Ÿå®¹å™¨ -->
  <div id="videoWrapper" class="card" style="position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:#000">
    <video id="camera" autoplay playsinline muted style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:12px"></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="overlay"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; z-index:10; opacity:.6;">
  </div>

  <!-- æ“ä½œ -->
  <div class="sticky-actions btn-group" style="justify-content:center; margin-top:16px">
    <button id="captureBtn" class="btn">ğŸ“¸ æ‹ç…§ + é€å‡ºåˆ¤æ–·ï¼ˆç·´ç¿’ï¼‰</button>
    <a class="btn btn-outline" href="{{ url_for('home') }}">è¿”å›é¦–é </a>
  </div>

  <!-- ä½ çš„è§€å¯Ÿï¼ˆæ‹ç…§å¾Œé¡¯ç¤ºï¼‰ -->
  <form id="diagForm" class="card" style="display:none; margin-top:16px">
    <h2>ä½ çš„è§€å¯Ÿ</h2>
    <p class="muted">è«‹ä¾è§€å¯Ÿé¸æ“‡å„å€é¡è‰²å‚¾å‘ï¼Œä¸¦å¯å¡«å¯«æ‘˜è¦ã€‚</p>

    <div class="grid grid-2">
      <label>å¿ƒï¼ˆèˆŒå°–ï¼‰
        <select class="input" name="å¿ƒ">
          <option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option>
        </select>
      </label>
      <label>è‚ï¼ˆå·¦èˆŒé‚Šï¼‰
        <select class="input" name="è‚">
          <option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option>
        </select>
      </label>
      <label>è„¾ï¼ˆä¸­é–“åå‰ï¼‰
        <select class="input" name="è„¾">
          <option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option>
        </select>
      </label>
      <label>è‚ºï¼ˆå³èˆŒé‚Šï¼‰
        <select class="input" name="è‚º">
          <option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option>
        </select>
      </label>
      <label>è…ï¼ˆèˆŒæ ¹ï¼‰
        <select class="input" name="è…">
          <option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option>
        </select>
      </label>
    </div>

    <label style="display:block; margin-top:12px">ä½ çš„ç¸½çµ
      <textarea class="input" name="summary" placeholder="å¯è£œå……è§€å¯Ÿé‡é»ï¼ˆä¾‹ï¼šèˆŒè³ªæ·¡ç´…ã€è‹”è–„ç™½ï¼Œé‚Šè¦‹é½’ç—•â€¦ï¼‰" rows="3"></textarea>
    </label>

    <div class="btn-group" style="margin-top:12px">
      <button type="submit" class="btn">é€å‡ºè¨ºæ–·</button>
      <button type="button" id="retakeBtn" class="btn btn-outline">é‡æ–°æ‹ç…§</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const form = document.getElementById("diagForm");
  const retakeBtn = document.getElementById("retakeBtn");

  let capturedBlob = null, stream = null;

  // å•Ÿå‹•ç›¸æ©Ÿ
  function startCamera(){
    navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" }}})
      .then(s => { stream = s; video.srcObject = s; video.onloadedmetadata = () => video.play(); })
      .catch(err => Swal.fire("âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err.message, "error"));
  }
  startCamera();

  // é‡æ–°æ‹ç…§
  retakeBtn?.addEventListener("click", ()=>{
    capturedBlob = null;
    form.style.display = "none";
    startCamera();
    window.scrollTo({ top: document.querySelector('.card').offsetTop, behavior: 'smooth' });
  });

  // æ‹ç…§ + é¡¯ç¤ºè¡¨å–®
  captureBtn.addEventListener("click", () => {
    if(!video.videoWidth){
      return Swal.fire("âš ï¸ ç›¸æ©Ÿå°šæœªå°±ç·’ï¼Œè«‹ç¨å€™å†è©¦");
    }
    const snap = document.createElement("canvas");
    snap.width = video.videoWidth;
    snap.height = video.videoHeight;
    const ctx = snap.getContext("2d");
    ctx.drawImage(video, 0, 0, snap.width, snap.height);
    ctx.drawImage(overlay, 0, 0, snap.width, snap.height);
    if (stream) stream.getTracks().forEach(t => t.stop());
    snap.toBlob(b => {
      capturedBlob = b;
      form.style.display = "block";
      window.scrollTo({top: form.offsetTop - 60, behavior:'smooth'});
    }, "image/jpeg");
  });

  // é€å‡ºåˆ° /practice/upload â†’ å›æ‡‰å¾Œç”¨æ¼‚äº®è¡¨æ ¼å‘ˆç¾
  form.addEventListener("submit", e => {
    e.preventDefault();
    if(!capturedBlob){
      return Swal.fire("âš ï¸ å°šæœªæ‹ç…§ï¼Œè«‹å…ˆæ‹ç…§å†é€å‡ºã€‚");
    }
    const fd = new FormData(form);
    const answers = { "å¿ƒ": fd.get("å¿ƒ"), "è‚": fd.get("è‚"), "è„¾": fd.get("è„¾"), "è‚º": fd.get("è‚º"), "è…": fd.get("è…") };

    const sendData = new FormData();
    sendData.append("image", capturedBlob, "practice.jpg");
    sendData.append("user_answers", JSON.stringify(answers));
    sendData.append("user_summary", fd.get("summary") || "");

    fetch("/practice/upload", { method: "POST", body: sendData })
      .then(r => { if (!r.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼š${r.status}`); return r.json(); })
      .then(data => {
        // â€”â€”â€” çµ„ SweetAlert å…§å®¹ï¼šç”¨ table-wrap + table æ¨£å¼ï¼Œé¢¨æ ¼èˆ‡å…¨ç«™ä¸€è‡´ â€”â€”â€”
        const userObs = data["ä½¿ç”¨è€…è§€å¯Ÿ"] || {};
        const sys = data["äº”å€åˆ†æ"] || {};
        const mainColor = data["èˆŒè‹”ä¸»è‰²"] || "";
        const lab = data["è‰²å½©å€¼"] || null;
        const userSummary = (data["ä½¿ç”¨è€…ç¸½çµ"] || "").toString().replace(/\n/g, "<br>");

        // ä½¿ç”¨è€…è§€å¯Ÿè¡¨
        let userTable = `
          <div class="table-wrap">
            <table class="table table-striped table-compact">
              <thead><tr><th style="width:120px">å€åŸŸ</th><th>ä½ çš„è§€å¯Ÿ</th></tr></thead>
              <tbody>
        `;
        Object.keys(userObs).forEach(k => {
          userTable += `<tr><td><strong>${k}</strong></td><td>${userObs[k] ?? '-'}</td></tr>`;
        });
        if(Object.keys(userObs).length === 0){
          userTable += `<tr><td colspan="2" class="cell-muted">ï¼ˆç„¡å¡«å¯«ï¼‰</td></tr>`;
        }
        userTable += `</tbody></table></div>`;

        // ç³»çµ±äº”å€åˆ†æè¡¨
        let sysTable = `
          <div class="table-wrap" style="margin-top:12px">
            <table class="table table-striped table-compact">
              <thead><tr><th style="width:120px">å€åŸŸ</th><th>è¨ºæ–·</th><th>ç†è«–</th><th>å»ºè­°</th></tr></thead>
              <tbody>
        `;
        const keys = Object.keys(sys);
        if(keys.length){
          keys.forEach(k => {
            const r = sys[k] || {};
            sysTable += `
              <tr>
                <td><strong>${r.å€åŸŸ ?? k}</strong></td>
                <td>${r.è¨ºæ–· ?? '-'}</td>
                <td class="cell-muted">${r.ç†è«– ?? '-'}</td>
                <td class="cell-muted">${r.å»ºè­° ?? '-'}</td>
              </tr>`;
          });
        }else{
          sysTable += `<tr><td colspan="4" class="cell-muted">ï¼ˆç„¡ç³»çµ±åˆ†æè³‡æ–™ï¼‰</td></tr>`;
        }
        sysTable += `</tbody></table></div>`;

        // ä¸»è‰²è²¼ç´™ + LAB
        const colorDetail = lab ? `<div class="small cell-muted">LABï¼šL=${lab[0]}, A=${lab[1]}, B=${lab[2]}</div>` : "";
        const mainColorBadge = mainColor
          ? `<div class="pill neutral" style="margin-top:6px"><span class="swatch" style="background:${mainColor};"></span> ä¸»è‰²ï¼š<b style="margin-left:4px">${mainColor}</b></div>`
          : "";

        Swal.fire({
          title:"ğŸ§  ç·´ç¿’åˆ¤è®€çµæœ",
          html: `
            ${mainColorBadge}
            ${colorDetail}
            <div class="card" style="margin-top:12px">
              <h2>ä½ çš„ç¸½çµ</h2>
              <div class="cell-muted" style="margin-top:6px">${userSummary || 'ï¼ˆç„¡ï¼‰'}</div>
            </div>
            <div class="card" style="margin-top:12px">
              <h2>ä½¿ç”¨è€…è§€å¯Ÿ</h2>
              ${userTable}
            </div>
            <div class="card" style="margin-top:12px">
              <h2>ç³»çµ±äº”å€åˆ†æ</h2>
              ${sysTable}
            </div>
          `,
          width: "64rem",
          confirmButtonText:"å®Œæˆ"
        });
      })
      .catch(err => Swal.fire("âŒ ä¸Šå‚³å¤±æ•—", err.message, "error"));
  });
</script>
{% endblock %}
