
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>中醫五區辨識練習</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#f0f0f0; text-align:center; }
    h2 { margin:1rem 0 .5rem; }
    #videoWrapper { position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:#000; }
    #camera, #overlay { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    #overlay { pointer-events:none; z-index:10; opacity:.6; }
    button { margin:1rem .5rem; padding:.6rem 1.2rem; font-size:1.05rem; border:0; border-radius:8px; background:#4a90e2; color:#fff; }
    button:hover { background:#357ABD; }
    .card { display:none; text-align:left; max-width:500px; margin:1rem auto; background:#fff; padding:1rem; border-radius:10px; }
    select, textarea { width:100%; margin-top:.25rem; }
    textarea { height:80px; }
  </style>
</head>
<body>
  <h2>中醫五區辨識練習</h2>

  <div id="videoWrapper">
    <video id="camera" autoplay playsinline muted></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="">
  </div>

  <div>
    <button id="captureBtn">拍照 + 送出判斷（練習）</button>
    <button onclick="location.href='/'">回到主頁</button>
  </div>

  <form id="diagForm" class="card">
    <h3>請觀察後選擇判斷：</h3>
    <label>心：</label><select name="心"><option>白苔</option><option>偏紅</option><option>偏黃</option><option>偏紫</option><option>偏黑灰</option></select><br>
    <label>肝：</label><select name="肝"><option>白苔</option><option>偏紅</option><option>偏黃</option><option>偏紫</option><option>偏黑灰</option></select><br>
    <label>脾：</label><select name="脾"><option>白苔</option><option>偏紅</option><option>偏黃</option><option>偏紫</option><option>偏黑灰</option></select><br>
    <label>肺：</label><select name="肺"><option>白苔</option><option>偏紅</option><option>偏黃</option><option>偏紫</option><option>偏黑灰</option></select><br>
    <label>腎：</label><select name="腎"><option>白苔</option><option>偏紅</option><option>偏黃</option><option>偏紫</option><option>偏黑灰</option></select><br>
    <label>你的總結：</label><textarea name="summary"></textarea><br>
    <button type="submit">送出診斷</button>
  </form>

<script>
  const video = document.getElementById("camera");
  const captureBtn = document.getElementById("captureBtn");
  const overlay = document.getElementById("overlay");
  const form = document.getElementById("diagForm");
  let capturedBlob = null, stream = null;

  // 相機預覽
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" }}})
    .then(s => { stream = s; video.srcObject = s; video.onloadedmetadata = () => video.play(); })
    .catch(err => Swal.fire("❌ 相機啟動失敗", err.message, "error"));

  // 拍照
  captureBtn.addEventListener("click", () => {
    const snap = document.createElement("canvas");
    snap.width = video.videoWidth;
    snap.height = video.videoHeight;
    const ctx = snap.getContext("2d");
    ctx.drawImage(video, 0, 0, snap.width, snap.height);
    ctx.drawImage(overlay, 0, 0, snap.width, snap.height);
    if (stream) stream.getTracks().forEach(t => t.stop());
    snap.toBlob(b => { capturedBlob = b; form.style.display = "block"; window.scrollTo({top: form.offsetTop, behavior:'smooth'}); }, "image/jpeg");
  });

  // 送出
  form.addEventListener("submit", e => {
    e.preventDefault();
    const fd = new FormData(form);
    const answers = { "心": fd.get("心"), "肝": fd.get("肝"), "脾": fd.get("脾"), "肺": fd.get("肺"), "腎": fd.get("腎") };

    const sendData = new FormData();
    sendData.append("image", capturedBlob);
    sendData.append("user_answers", JSON.stringify(answers));
    sendData.append("user_summary", fd.get("summary"));

    fetch("/practice/upload", { method: "POST", body: sendData })
      .then(r => {
        if (!r.ok) throw new Error(`伺服器錯誤：${r.status}`);
        return r.json();
      })
      .then(data => {
        // 使用者觀察
        let userTable = "<table style='border-collapse:collapse;width:100%'><tr><th>區域</th><th>使用者觀察</th></tr>";
        Object.keys(data["使用者觀察"]||{}).forEach(k => userTable += `<tr><td>${k}</td><td>${data["使用者觀察"][k]}</td></tr>`);
        userTable += "</table>";

        // 系統五區分析
        let sysTable = "<table style='border-collapse:collapse;width:100%;margin-top:1rem'><tr><th>區域</th><th>診斷</th><th>理論</th><th>建議</th></tr>";
        Object.keys(data["五區分析"]||{}).forEach(k => {
          const r = data["五區分析"][k] || {};
          sysTable += `<tr><td>${r.區域||""}</td><td>${r.診斷||""}</td><td>${r.理論||""}</td><td>${r.建議||""}</td></tr>`;
        });
        sysTable += "</table>";

        const colorDetail = data["色彩值"] ? `<br><b>LAB：</b>L=${data["色彩值"][0]}, A=${data["色彩值"][1]}, B=${data["色彩值"][2]}` : "";

        Swal.fire({
          title:"🧠 練習判讀結果",
          html:`<b>舌苔主色：</b>${data["舌苔主色"]||""}${colorDetail}<br><br>
                <b>你的總結：</b><br>${data["使用者總結"]||""}<br><br>
                <b>使用者觀察：</b><br>${userTable}<br><br>
                <b>系統五區分析：</b><br>${sysTable}`,
          icon:"info",
          confirmButtonText:"完成"
        });
      })
      .catch(err => Swal.fire("❌ 上傳失敗", err.message, "error"));
  });
</script>
</body>
</html>
