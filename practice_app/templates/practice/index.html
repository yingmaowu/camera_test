
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸­é†«äº”å€è¾¨è­˜ç·´ç¿’</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#f0f0f0; text-align:center; }
    h2 { margin:1rem 0 .5rem; }
    #videoWrapper { position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:#000; }
    #camera, #overlay { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    #overlay { pointer-events:none; z-index:10; opacity:.6; }
    button { margin:1rem .5rem; padding:.6rem 1.2rem; font-size:1.05rem; border:0; border-radius:8px; background:#4a90e2; color:#fff; }
    button:hover { background:#357ABD; }
    .card { display:none; text-align:left; max-width:500px; margin:1rem auto; background:#fff; padding:1rem; border-radius:10px; }
    select, textarea { width:100%; margin-top:.25rem; }
    textarea { height:80px; }
  </style>
</head>
<body>
  <h2>ä¸­é†«äº”å€è¾¨è­˜ç·´ç¿’</h2>

  <div id="videoWrapper">
    <video id="camera" autoplay playsinline muted></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="">
  </div>

  <div>
    <button id="captureBtn">æ‹ç…§ + é€å‡ºåˆ¤æ–·ï¼ˆç·´ç¿’ï¼‰</button>
    <button onclick="location.href='/'">å›åˆ°ä¸»é </button>
  </div>

  <form id="diagForm" class="card">
    <h3>è«‹è§€å¯Ÿå¾Œé¸æ“‡åˆ¤æ–·ï¼š</h3>
    <label>å¿ƒï¼š</label><select name="å¿ƒ"><option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option></select><br>
    <label>è‚ï¼š</label><select name="è‚"><option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option></select><br>
    <label>è„¾ï¼š</label><select name="è„¾"><option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option></select><br>
    <label>è‚ºï¼š</label><select name="è‚º"><option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option></select><br>
    <label>è…ï¼š</label><select name="è…"><option>ç™½è‹”</option><option>åç´…</option><option>åé»ƒ</option><option>åç´«</option><option>åé»‘ç°</option></select><br>
    <label>ä½ çš„ç¸½çµï¼š</label><textarea name="summary"></textarea><br>
    <button type="submit">é€å‡ºè¨ºæ–·</button>
  </form>

<script>
  const video = document.getElementById("camera");
  const captureBtn = document.getElementById("captureBtn");
  const overlay = document.getElementById("overlay");
  const form = document.getElementById("diagForm");
  let capturedBlob = null, stream = null;

  // ç›¸æ©Ÿé è¦½
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" }}})
    .then(s => { stream = s; video.srcObject = s; video.onloadedmetadata = () => video.play(); })
    .catch(err => Swal.fire("âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err.message, "error"));

  // æ‹ç…§
  captureBtn.addEventListener("click", () => {
    const snap = document.createElement("canvas");
    snap.width = video.videoWidth;
    snap.height = video.videoHeight;
    const ctx = snap.getContext("2d");
    ctx.drawImage(video, 0, 0, snap.width, snap.height);
    ctx.drawImage(overlay, 0, 0, snap.width, snap.height);
    if (stream) stream.getTracks().forEach(t => t.stop());
    snap.toBlob(b => { capturedBlob = b; form.style.display = "block"; window.scrollTo({top: form.offsetTop, behavior:'smooth'}); }, "image/jpeg");
  });

  // é€å‡º
  form.addEventListener("submit", e => {
    e.preventDefault();
    const fd = new FormData(form);
    const answers = { "å¿ƒ": fd.get("å¿ƒ"), "è‚": fd.get("è‚"), "è„¾": fd.get("è„¾"), "è‚º": fd.get("è‚º"), "è…": fd.get("è…") };

    const sendData = new FormData();
    sendData.append("image", capturedBlob);
    sendData.append("user_answers", JSON.stringify(answers));
    sendData.append("user_summary", fd.get("summary"));

    fetch("/practice/upload", { method: "POST", body: sendData })
      .then(r => {
        if (!r.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼š${r.status}`);
        return r.json();
      })
      .then(data => {
        // ä½¿ç”¨è€…è§€å¯Ÿ
        let userTable = "<table style='border-collapse:collapse;width:100%'><tr><th>å€åŸŸ</th><th>ä½¿ç”¨è€…è§€å¯Ÿ</th></tr>";
        Object.keys(data["ä½¿ç”¨è€…è§€å¯Ÿ"]||{}).forEach(k => userTable += `<tr><td>${k}</td><td>${data["ä½¿ç”¨è€…è§€å¯Ÿ"][k]}</td></tr>`);
        userTable += "</table>";

        // ç³»çµ±äº”å€åˆ†æ
        let sysTable = "<table style='border-collapse:collapse;width:100%;margin-top:1rem'><tr><th>å€åŸŸ</th><th>è¨ºæ–·</th><th>ç†è«–</th><th>å»ºè­°</th></tr>";
        Object.keys(data["äº”å€åˆ†æ"]||{}).forEach(k => {
          const r = data["äº”å€åˆ†æ"][k] || {};
          sysTable += `<tr><td>${r.å€åŸŸ||""}</td><td>${r.è¨ºæ–·||""}</td><td>${r.ç†è«–||""}</td><td>${r.å»ºè­°||""}</td></tr>`;
        });
        sysTable += "</table>";

        const colorDetail = data["è‰²å½©å€¼"] ? `<br><b>LABï¼š</b>L=${data["è‰²å½©å€¼"][0]}, A=${data["è‰²å½©å€¼"][1]}, B=${data["è‰²å½©å€¼"][2]}` : "";

        Swal.fire({
          title:"ğŸ§  ç·´ç¿’åˆ¤è®€çµæœ",
          html:`<b>èˆŒè‹”ä¸»è‰²ï¼š</b>${data["èˆŒè‹”ä¸»è‰²"]||""}${colorDetail}<br><br>
                <b>ä½ çš„ç¸½çµï¼š</b><br>${data["ä½¿ç”¨è€…ç¸½çµ"]||""}<br><br>
                <b>ä½¿ç”¨è€…è§€å¯Ÿï¼š</b><br>${userTable}<br><br>
                <b>ç³»çµ±äº”å€åˆ†æï¼š</b><br>${sysTable}`,
          icon:"info",
          confirmButtonText:"å®Œæˆ"
        });
      })
      .catch(err => Swal.fire("âŒ ä¸Šå‚³å¤±æ•—", err.message, "error"));
  });
</script>
</body>
</html>
