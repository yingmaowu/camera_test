{% extends "base.html" %}
{% block title %}æ­·å²ç´€éŒ„{% endblock %}
{% block content %}
<div class="card">
  <h1>ğŸ“ æ­·å²ç…§ç‰‡ç´€éŒ„</h1>
  <p class="muted">ç€è¦½éå¾€æ‹æ”å½±åƒèˆ‡äº”å€è¨ºæ–·ã€‚</p>

  <!-- ç…§ç‰‡æ ¼ç‹€æ¸…å–® -->
  <div id="photoGrid" class="grid grid-3" style="margin-top:20px"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const photoGrid = document.getElementById("photoGrid");
  const patientId = new URLSearchParams(window.location.search).get("patient") || "";

  fetch(`/history_data?patient=${patientId}`)
    .then(res => res.json())
    .then(records => {
      if (!records.length) {
        photoGrid.innerHTML = "<p class='muted'>å°šç„¡ç…§ç‰‡</p>";
        return;
      }
      records.forEach(record => {
        const card = document.createElement("div");
        card.className = "photo-card card";
        card.style.cursor = "pointer";

        // ç…§ç‰‡
        const img = document.createElement("img");
        img.src = record.image_url;
        img.style.borderRadius = "12px 12px 0 0";

        // æ™‚é–“
        const time = document.createElement("div");
        time.className = "timestamp muted";
        time.textContent = new Date(record.timestamp).toLocaleString("zh-TW");

        card.appendChild(img);
        card.appendChild(time);

        // é»æ“Šå¡ç‰‡ â†’ å½ˆçª—
        card.onclick = () => {
          let table = "<table style='margin:auto; border-collapse:collapse; width:100%'><tr><th>å€åŸŸ</th><th>è¨ºæ–·</th><th>ç†è«–</th><th>å»ºè­°</th></tr>";
          if (record.five_regions) {
            Object.values(record.five_regions).forEach(r => {
              table += `<tr><td>${r.å€åŸŸ}</td><td>${r.è¨ºæ–·}</td><td>${r.ç†è«–}</td><td>${r.å»ºè­°}</td></tr>`;
            });
          } else {
            table += "<tr><td colspan='4'>ç„¡äº”å€è¨ºæ–·è³‡æ–™</td></tr>";
          }
          table += "</table>";

          Swal.fire({
            title: "ğŸ§  åˆ¤è®€çµæœ",
            html: `
              <b>èˆŒè‹”ä¸»è‰²ï¼š</b> ${record.main_color || "ç„¡è³‡æ–™"}<br><br>
              ${table}
            `,
            confirmButtonText: "é—œé–‰",
            width: "80%"
          });
        };

        photoGrid.appendChild(card);
      });
    });
</script>
{% endblock %}
