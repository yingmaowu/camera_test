<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>歷史照片記錄</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { margin: 0; font-family: sans-serif; background: #f2f2f2; text-align: center; }
    h2 { margin-top: 1rem; }
    .record { margin: 1rem auto; padding: 1rem; background: white; border-radius: 8px; max-width: 500px; }
    .record img {
      width: 150%;
      transform: translateX(-25%);
      aspect-ratio: 3 / 4;
      object-fit: cover;
      border-radius: 8px;
    }
    .timestamp { font-size: 0.9rem; color: #555; margin-top: 0.5rem; }
    .btn { margin: 0.5rem; padding: 0.4rem 1rem; font-size: 1rem; border: none; border-radius: 6px; background: #4a90e2; color: white; cursor: pointer; }
    .btn:hover { background-color: #357ABD; }
  </style>
</head>
<body>
  <h2>📁 歷史照片記錄</h2>
  <button class="btn" onclick="history.back()">上一頁</button>
  <div id="records"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("patient") || "unknown";

    function createRecordElement(record) {
      const div = document.createElement("div");
      div.className = "record";

      const img = document.createElement("img");
      img.src = record.image_url;
      img.alt = "舌照圖片";

      const time = document.createElement("div");
      time.className = "timestamp";
      time.innerText = record.timestamp;

      const delBtn = document.createElement("button");
      delBtn.className = "btn";
      delBtn.innerText = "刪除紀錄";
      delBtn.onclick = () => {
        Swal.fire({
          title: "確定要刪除這筆紀錄嗎？",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "刪除",
          cancelButtonText: "取消"
        }).then(result => {
          if (result.isConfirmed) {
            fetch("/delete_record", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: record._id })
            }).then(res => res.json()).then(data => {
              if (data.success) {
                Swal.fire("✅ 已刪除", "", "success").then(() => location.reload());
              } else {
                Swal.fire("❌ 刪除失敗", data.error || "請稍後再試", "error");
              }
            });
          }
        });
      };

      const markBtn = document.createElement("button");
      markBtn.className = "btn";
      markBtn.innerText = "顯示舌苔標記圖";
      markBtn.onclick = () => {
        window.open(`/static/processed/${record._id}.jpg`, "_blank");
      };

      div.appendChild(img);
      div.appendChild(time);
      div.appendChild(delBtn);
      div.appendChild(markBtn);
      return div;
    }

    fetch(`/history_data?patient=${patientId}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("records");
        if (Array.isArray(data)) {
          data.forEach(record => {
            container.appendChild(createRecordElement(record));
          });
        } else {
          Swal.fire("❌ 載入失敗", data.error || "請稍後再試", "error");
        }
      });
  </script>
</body>
</html>
