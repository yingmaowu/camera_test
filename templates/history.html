{% extends "base.html" %}
{% block title %}æ­·å²ç´€éŒ„{% endblock %}
{% block content %}
<div class="card">
  <h1>ğŸ“ æ­·å²ç…§ç‰‡ç´€éŒ„</h1>
  <p class="muted">ç€è¦½éå¾€æ‹æ”å½±åƒèˆ‡äº”å€è¨ºæ–·ã€‚</p>
  <div id="photoGrid" class="grid grid-3" style="margin-top:12px"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const photoGrid = document.getElementById("photoGrid");
  const patientId = ("{{ patient_id|default('') }}".trim()) || new URLSearchParams(location.search).get("patient") || "";
  if (!patientId) location.href = "{{ url_for('id_input', next='history') }}";

  fetch(`{{ url_for('get_history_data') }}?patient=${encodeURIComponent(patientId)}`)
    .then(res => res.json())
    .then(records => {
      if (!records.length) { photoGrid.innerHTML = "<p class='muted'>å°šç„¡ç…§ç‰‡</p>"; return; }
      records.forEach(record => {
        const card = document.createElement("div");
        card.className = "photo-card card"; card.style.cursor = "pointer";

        const img = document.createElement("img");
        img.src = record.image_url; img.alt = "èˆŒç…§"; img.style.borderRadius = "12px 12px 0 0";
        img.onerror = () => { img.src = "{{ url_for('static', filename='img/missing.png') }}"; img.alt = "åœ–ç‰‡å·²åˆªé™¤"; card.classList.add("is-missing"); };

        const meta = document.createElement("div");
        meta.className = "muted"; meta.style.padding = "8px 10px";
        try { meta.textContent = new Date(record.timestamp).toLocaleString("zh-TW"); }
        catch { meta.textContent = record.timestamp || ""; }

        card.appendChild(img); card.appendChild(meta);
        card.onclick = () => {
          let table = "<div class='table-wrap'><table class='table table-compact'><thead><tr><th>å€åŸŸ</th><th>è¨ºæ–·</th><th>ç†è«–</th><th>å»ºè­°</th></tr></thead><tbody>";
          if (record.five_regions) {
            Object.values(record.five_regions).forEach(r => {
              table += `<tr><td>${r.å€åŸŸ||''}</td><td>${r.è¨ºæ–·||''}</td><td class='cell-muted'>${r.ç†è«–||''}</td><td class='cell-muted'>${r.å»ºè­°||''}</td></tr>`;
            });
          } else { table += "<tr><td colspan='4' class='cell-muted'>ç„¡äº”å€è¨ºæ–·è³‡æ–™</td></tr>"; }
          table += "</tbody></table></div>";

          const mainColor = record.main_color ? `<span class="swatch" style="background:${record.main_color}; margin-right:6px"></span><b>${record.main_color}</b>` : "ç„¡è³‡æ–™";
          Swal.fire({
            title: "ğŸ§  åˆ¤è®€çµæœ",
            html: `<div style="text-align:left"><p><b>èˆŒè‹”ä¸»è‰²ï¼š</b> ${mainColor}</p>${table}</div>`,
            confirmButtonText: "é—œé–‰", width: "100%", maxWidth: "640px"
          });
        };
        photoGrid.appendChild(card);
      });
    })
    .catch(e=>{ photoGrid.innerHTML = `<div class="alert error">è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>`; });
</script>
{% endblock %}
