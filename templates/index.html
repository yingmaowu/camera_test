{% extends "base.html" %}
{% block title %}èˆŒè‹”è¾¨è­˜ç›¸æ©Ÿ{% endblock %}
{% block content %}
<div class="card">
  <h1>èˆŒè‹”è¾¨è­˜ç›¸æ©Ÿ</h1>
  <p class="muted">å°æº–ç–Šåœ–ç¯„åœï¼Œä¿æŒå…‰ç·šå‡å‹»å†æ‹ç…§ã€‚</p>

  <div id="videoWrapper" class="card" style="position:relative; width:100%; max-width:520px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:#000">
    <video id="camera" autoplay playsinline muted style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:12px"></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="overlay"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; z-index:10; opacity:.6;">
  </div>

  <div class="sticky-actions btn-group" style="margin-top:12px">
    <button id="captureBtn" class="btn">ğŸ“¸ æ‹ç…§ä¸¦ä¸Šå‚³</button>
    <button id="historyBtn" class="btn btn-outline">ğŸ“ æŸ¥çœ‹æ­·å²</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const historyBtn = document.getElementById("historyBtn");
  const patientId = ("{{ patient_id|default('') }}".trim()) || new URLSearchParams(location.search).get("patient") || "";

  if (!patientId) location.href = "{{ url_for('id_input', next='index') }}";

  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => { video.srcObject = stream; return new Promise(r => video.onloadedmetadata = () => (video.play(), r())); })
    .catch(err => Swal.fire("âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err.message, "error"));

  let capturedBlob = null;
  async function captureImage(){
    if(!video.videoWidth){ throw new Error("ç›¸æ©Ÿæœªå°±ç·’"); }
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
    return new Promise(res => canvas.toBlob(b => (capturedBlob = b, res()), "image/jpeg"));
  }

  captureBtn.addEventListener("click", async () => {
    try{
      await captureImage();
      const fd = new FormData();
      fd.append("image", capturedBlob, "tongue.jpg");
      fd.append("patient_id", patientId);

      const resp = await fetch("{{ url_for('upload_image') }}", { method:"POST", body: fd });
      const d = await resp.json();
      if(d.success){
        Swal.fire("âœ… ä¸Šå‚³æˆåŠŸ","å³å°‡è·³è½‰è‡³æ­·å²ç´€éŒ„","success")
          .then(()=>location.href=`{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`);
      }else{
        Swal.fire("âŒ ä¸Šå‚³å¤±æ•—", d.error || "è«‹ç¨å¾Œå†è©¦", "error");
      }
    }catch(e){ Swal.fire("âŒ æ‹ç…§å¤±æ•—", e.message, "error"); }
  });

  historyBtn.addEventListener("click", ()=> location.href = `{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`);
</script>
{% endblock %}
