{% extends "base.html" %}
{% block title %}èˆŒè‹”è¾¨è­˜ç›¸æ©Ÿ{% endblock %}
{% block content %}
<div class="card">
  <h1>èˆŒè‹”è¾¨è­˜ç›¸æ©Ÿ</h1>
  <p class="muted">è«‹å°‡èˆŒé ­å°æº–ç–Šåœ–ç¯„åœï¼Œä¿æŒå…‰ç·šå‡å‹»å†æ‹ç…§ã€‚</p>

  <!-- ç›¸æ©Ÿå®¹å™¨ -->
  <div id="videoWrapper" style="position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:black; border-radius:12px">
    <video id="camera" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover; border-radius:12px"></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="overlay"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; z-index:10;">
  </div>

  <!-- æ“ä½œæŒ‰éˆ• -->
  <div class="sticky-actions flex center" style="justify-content:center; margin-top:16px">
    <button id="captureBtn" class="btn">ğŸ“¸ æ‹ç…§ä¸¦ä¸Šå‚³</button>
    <button id="historyBtn" class="btn btn-outline">ğŸ“ æŸ¥çœ‹æ­·å²</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const historyBtn = document.getElementById("historyBtn");

  // å¾å¾Œç«¯å¸¶å…¥çš„ patient_idï¼ˆè‹¥æœ‰ï¼‰ï¼Œå¦å‰‡é€€å› querystring çš„ patient
  const patientId =
    "{{ patient_id|default('') }}"?.trim() ||
    new URLSearchParams(window.location.search).get("patient") ||
    "";

  // æ²’æœ‰ç—…æ‚£IDå°±å°å›è¼¸å…¥é ï¼ˆå¾Œç«¯ä¹Ÿå»ºè­°åŠ é˜²å‘†ï¼‰
  if (!patientId) {
    window.location.href = "{{ url_for('id_input', next='index') }}";
  }

  // å•Ÿå‹•ç›¸æ©Ÿ
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => { video.srcObject = stream; return new Promise(r => video.onloadedmetadata = () => (video.play(), r())); })
    .catch(err => Swal.fire("âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err.message, "error"));

  let capturedBlob = null;

  function captureImage() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
    return new Promise(resolve => canvas.toBlob(b => (capturedBlob = b, resolve()), "image/jpeg"));
  }

  captureBtn.addEventListener("click", async () => {
    await captureImage();
    Swal.fire({ title:"ç¢ºå®šè¦ä¸Šå‚³é€™å¼µç…§ç‰‡å—ï¼Ÿ", icon:"question", showCancelButton:true, confirmButtonText:"ä¸Šå‚³", cancelButtonText:"å–æ¶ˆ" })
      .then(res=>{
        if(res.isConfirmed && capturedBlob){
          const fd = new FormData();
          fd.append("image", capturedBlob, "tongue.jpg");
          fd.append("patient_id", patientId);

          // â¬…ï¸ ä¿®æ­£é€™è£¡ï¼šæ”¹ç”¨æ­£ç¢ºçš„ endpoint åç¨± upload_image
          fetch("{{ url_for('upload_image') }}", { method:"POST", body: fd })
            .then(r=>r.json())
            .then(d=>{
              if(d.success){
                Swal.fire("âœ… ä¸Šå‚³æˆåŠŸ","å³å°‡è·³è½‰è‡³æ­·å²ç´€éŒ„","success")
                  .then(()=>location.href=`{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`);
              }else{
                Swal.fire("âŒ ä¸Šå‚³å¤±æ•—", d.error || "è«‹ç¨å¾Œå†è©¦", "error");
              }
            })
            .catch(e=>Swal.fire("âŒ éŒ¯èª¤", e.message, "error"));
        }
      });
  });

  historyBtn.addEventListener("click", ()=>{
    location.href = `{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`;
  });
</script>
{% endblock %}
