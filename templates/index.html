{% extends "base.html" %}
{% block title %}舌苔辨識相機{% endblock %}
{% block content %}
<div class="card">
  <h1>舌苔辨識相機</h1>
  <p class="muted">請將舌頭對準疊圖範圍，保持光線均勻再拍照。</p>

  <!-- 相機容器 -->
  <div id="videoWrapper" style="position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:black; border-radius:12px">
    <video id="camera" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover; border-radius:12px"></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="overlay"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; z-index:10;">
  </div>

  <!-- 操作按鈕 -->
  <div class="sticky-actions flex center" style="justify-content:center; margin-top:16px">
    <button id="captureBtn" class="btn">📸 拍照並上傳</button>
    <button id="historyBtn" class="btn btn-outline">📁 查看歷史</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const historyBtn = document.getElementById("historyBtn");
  const patientId = new URLSearchParams(window.location.search).get("patient") || "unknown";

  // 解決返回上一頁相機黑畫面問題
  window.addEventListener("pageshow", function(event) {
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
      window.location.reload();
    }
  });

  // 啟動相機
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => {
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => {
          video.play();
          resolve();
        };
      });
    })
    .catch(err => {
      Swal.fire("❌ 相機啟動失敗", err.message, "error");
    });

  let capturedBlob = null;

  // 拍照（含 overlay 疊圖）
  function captureImage() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
    return new Promise(resolve => {
      canvas.toBlob(blob => {
        capturedBlob = blob;
        resolve();
      }, "image/jpeg");
    });
  }

  // 點擊拍照並上傳
  captureBtn.addEventListener("click", async () => {
    await captureImage();
    Swal.fire({
      title: "確定要上傳這張照片嗎？",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "上傳",
      cancelButtonText: "取消"
    }).then(result => {
      if (result.isConfirmed && capturedBlob) {
        const formData = new FormData();
        formData.append("image", capturedBlob, "tongue.jpg");
        formData.append("patient_id", patientId);

        fetch("/upload", { method: "POST", body: formData })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              Swal.fire("✅ 上傳成功", "即將跳轉至健康紀錄", "success").then(() => {
                window.location.href = `/history?patient=${patientId}`;
              });
            } else {
              Swal.fire("❌ 上傳失敗", data.error || "請稍後再試", "error");
            }
          })
          .catch(err => {
            Swal.fire("❌ 錯誤", err.message, "error");
          });
      }
    });
  });

  // 查看歷史
  historyBtn.addEventListener("click", () => {
    window.location.href = `/history?patient=${patientId}`;
  });
</script>
{% endblock %}
