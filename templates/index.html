{% extends "base.html" %}
{% block title %}舌苔辨識相機{% endblock %}
{% block content %}
<div class="card">
  <h1>舌苔辨識相機</h1>
  <p class="muted">請將舌頭對準疊圖範圍，保持光線均勻再拍照。</p>

  <!-- 相機容器 -->
  <div id="videoWrapper" style="position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:black; border-radius:12px">
    <video id="camera" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover; border-radius:12px"></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="overlay"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; z-index:10;">
  </div>

  <!-- 操作按鈕 -->
  <div class="sticky-actions flex center" style="justify-content:center; margin-top:16px">
    <button id="captureBtn" class="btn">📸 拍照並上傳</button>
    <button id="historyBtn" class="btn btn-outline">📁 查看歷史</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const historyBtn = document.getElementById("historyBtn");

  // 從後端帶入的 patient_id（若有），否則退回 querystring 的 patient
  const patientId =
    "{{ patient_id|default('') }}"?.trim() ||
    new URLSearchParams(window.location.search).get("patient") ||
    "";

  // 沒有病患ID就導回輸入頁（後端也建議加防呆）
  if (!patientId) {
    window.location.href = "{{ url_for('id_input', next='index') }}";
  }

  // 啟動相機
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => { video.srcObject = stream; return new Promise(r => video.onloadedmetadata = () => (video.play(), r())); })
    .catch(err => Swal.fire("❌ 相機啟動失敗", err.message, "error"));

  let capturedBlob = null;

  function captureImage() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
    return new Promise(resolve => canvas.toBlob(b => (capturedBlob = b, resolve()), "image/jpeg"));
  }

  captureBtn.addEventListener("click", async () => {
    await captureImage();
    Swal.fire({ title:"確定要上傳這張照片嗎？", icon:"question", showCancelButton:true, confirmButtonText:"上傳", cancelButtonText:"取消" })
      .then(res=>{
        if(res.isConfirmed && capturedBlob){
          const fd = new FormData();
          fd.append("image", capturedBlob, "tongue.jpg");
          fd.append("patient_id", patientId);

          // ⬅️ 修正這裡：改用正確的 endpoint 名稱 upload_image
          fetch("{{ url_for('upload_image') }}", { method:"POST", body: fd })
            .then(r=>r.json())
            .then(d=>{
              if(d.success){
                Swal.fire("✅ 上傳成功","即將跳轉至歷史紀錄","success")
                  .then(()=>location.href=`{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`);
              }else{
                Swal.fire("❌ 上傳失敗", d.error || "請稍後再試", "error");
              }
            })
            .catch(e=>Swal.fire("❌ 錯誤", e.message, "error"));
        }
      });
  });

  historyBtn.addEventListener("click", ()=>{
    location.href = `{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`;
  });
</script>
{% endblock %}
