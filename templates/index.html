{% extends "base.html" %}
{% block title %}舌苔辨識相機{% endblock %}
{% block content %}
<div class="card">
  <h1>舌苔辨識相機</h1>
  <p class="muted">對準疊圖範圍，保持光線均勻再拍照。</p>

  <div id="videoWrapper" class="card" style="position:relative; width:100%; max-width:520px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:#000">
    <video id="camera" autoplay playsinline muted style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:12px"></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="overlay"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; z-index:10; opacity:.6;">
  </div>

  <div class="sticky-actions btn-group" style="margin-top:12px">
    <button id="captureBtn" class="btn">📸 拍照並上傳</button>
    <button id="historyBtn" class="btn btn-outline">📁 查看歷史</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const historyBtn = document.getElementById("historyBtn");
  const patientId = ("{{ patient_id|default('') }}".trim()) || new URLSearchParams(location.search).get("patient") || "";

  if (!patientId) location.href = "{{ url_for('id_input', next='index') }}";

  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => { video.srcObject = stream; return new Promise(r => video.onloadedmetadata = () => (video.play(), r())); })
    .catch(err => Swal.fire("❌ 相機啟動失敗", err.message, "error"));

  let capturedBlob = null;
  async function captureImage(){
    if(!video.videoWidth){ throw new Error("相機未就緒"); }
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
    return new Promise(res => canvas.toBlob(b => (capturedBlob = b, res()), "image/jpeg"));
  }

  captureBtn.addEventListener("click", async () => {
    try{
      await captureImage();
      const fd = new FormData();
      fd.append("image", capturedBlob, "tongue.jpg");
      fd.append("patient_id", patientId);

      const resp = await fetch("{{ url_for('upload_image') }}", { method:"POST", body: fd });
      const d = await resp.json();
      if(d.success){
        Swal.fire("✅ 上傳成功","即將跳轉至歷史紀錄","success")
          .then(()=>location.href=`{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`);
      }else{
        Swal.fire("❌ 上傳失敗", d.error || "請稍後再試", "error");
      }
    }catch(e){ Swal.fire("❌ 拍照失敗", e.message, "error"); }
  });

  historyBtn.addEventListener("click", ()=> location.href = `{{ url_for('history') }}?patient=${encodeURIComponent(patientId)}`);
</script>
{% endblock %}
