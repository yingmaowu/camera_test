{% extends "base.html" %}
{% block title %}ç›¸æ©Ÿæ‹ç…§{% endblock %}
{% block content %}
<div class="card">
  <h1>èˆŒè‹”è¾¨è­˜ç›¸æ©Ÿ</h1>
  <p class="muted">è«‹å°æº–èˆŒé ­æ–¼ç–Šåœ–ç¯„åœå…§å†æ‹æ”ï¼Œä¿æŒå…‰ç·šå‡å‹»ã€‚</p>

  <!-- ç›¸æ©Ÿå®¹å™¨ -->
  <div id="videoWrapper" style="position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:black; border-radius:12px">
    <video id="video" autoplay playsinline muted style="width:150%; transform:translateX(-25%); object-fit:cover; border-radius:12px"></video>

    <!-- ç–Šåœ–ï¼ˆç¢ºä¿è·¯å¾‘æ­£ç¢ºï¼‰ -->
    <img id="overlay" alt="overlay"
         src="{{ url_for('static', filename='overlay.png') }}"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none;">

    <!-- æ‹ç…§ç•«å¸ƒï¼ˆéš±è—ç”¨ä¾†æ“·å–ï¼‰ -->
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <!-- ç—…æ‚£IDè¼¸å…¥ï¼ˆè‹¥å·²æœ‰ï¼Œä¿ç•™ä½ çš„æ—¢æœ‰è¡¨å–®ï¼‰ -->
  <div class="grid grid-2" style="margin-top:16px">
    <div>
      <label class="muted">ç—…æ‚£ ID</label>
      <input class="input" id="patientId" placeholder="è¼¸å…¥ç—…æ‚£ ID">
    </div>
    <div class="flex" style="align-items:flex-end">
      <button id="btn-start" class="btn">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btn-stop" class="btn btn-outline">åœæ­¢ç›¸æ©Ÿ</button>
    </div>
  </div>

  <!-- å›ºå®šåº•éƒ¨æ“ä½œåˆ—ï¼šæ‹ç…§ / ä¸Šå‚³ -->
  <div class="sticky-actions">
    <div class="flex center" style="justify-content:center">
      <button id="btn-capture" class="btn">ğŸ“¸ æ‹ç…§</button>
      <button id="btn-upload" class="btn btn-outline">â˜ï¸ ä¸Šå‚³</button>
    </div>
  </div>

  <!-- è‹¥ä½ åŸæœ¬é é¢é‚„æœ‰å…¶å®ƒå€å¡Šï¼ˆä¾‹å¦‚åˆ†æçµæœå³æ™‚é¡¯ç¤ºï¼‰ï¼Œè«‹è²¼åœ¨é€™è£¡ -->
  {# åŸ index.html å…¶å®ƒå…§å®¹æ”¾é€™è£¡ #}
</div>
{% endblock %}
{% block scripts %}
<script>
  // é€™è£¡åƒ…ä¿ç•™å¸¸ç”¨ idï¼Œç´°éƒ¨è¡Œç‚ºæ²¿ç”¨ä½ åŸæœ¬çš„ JSï¼ˆå¦‚å·²å­˜åœ¨è«‹åˆªé™¤é€™æ®µï¼‰
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const btnStart = document.getElementById('btn-start');
  const btnStop = document.getElementById('btn-stop');
  const btnCap = document.getElementById('btn-capture');
  const btnUpload = document.getElementById('btn-upload');

  async function startCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
      video.srcObject = stream;
      showToast("ç›¸æ©Ÿå·²å•Ÿå‹•","success");
    }catch(e){
      showToast("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—","error");
      console.error(e);
    }
  }
  function stopCamera(){
    const s = video.srcObject; if(!s) return;
    s.getTracks().forEach(t=>t.stop()); video.srcObject=null;
    showToast("ç›¸æ©Ÿå·²åœæ­¢","info");
  }
  function capture(){
    const w = video.videoWidth, h = video.videoHeight;
    if(!w || !h){ showToast("ç›¸æ©Ÿå°šæœªå°±ç·’","error"); return; }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    showToast("å·²æ‹ç…§");
  }
  async function upload(){
    // é€™è£¡ä¿ç•™éˆå­ï¼Œå¯¦éš›ä¸Šå‚³æ²¿ç”¨ä½ æ—¢æœ‰çš„ fetch/è¡¨å–®æäº¤
    try{
      showToast("ä¸Šå‚³ä¸­â€¦","info");
      // e.g. const blob = await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.9));
      // await fetch("/upload", {method:"POST", body: formData});
      showToast("ä¸Šå‚³æˆåŠŸ","success");
    }catch(e){
      console.error(e);
      showToast("ä¸Šå‚³å¤±æ•—","error");
    }
  }
  btnStart?.addEventListener('click', startCamera);
  btnStop?.addEventListener('click', stopCamera);
  btnCap?.addEventListener('click', capture);
  btnUpload?.addEventListener('click', upload);
</script>
{% endblock %}
