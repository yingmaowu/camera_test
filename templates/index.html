{% extends "base.html" %}
{% block title %}èˆŒè‹”è¾¨è­˜ç›¸æ©Ÿ{% endblock %}
{% block content %}
<div class="card">
  <h1>èˆŒè‹”è¾¨è­˜ç›¸æ©Ÿ</h1>
  <p class="muted">è«‹å°‡èˆŒé ­å°æº–ç–Šåœ–ç¯„åœï¼Œä¿æŒå…‰ç·šå‡å‹»å†æ‹ç…§ã€‚</p>

  <!-- ç›¸æ©Ÿå®¹å™¨ -->
  <div id="videoWrapper" style="position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:black; border-radius:12px">
    <video id="camera" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover; border-radius:12px"></video>
    <img id="overlay" src="{{ url_for('static', filename='overlay.png') }}" alt="overlay"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none; z-index:10;">
  </div>

  <!-- æ“ä½œæŒ‰éˆ• -->
  <div class="sticky-actions flex center" style="justify-content:center; margin-top:16px">
    <button id="captureBtn" class="btn">ğŸ“¸ æ‹ç…§ä¸¦ä¸Šå‚³</button>
    <button id="historyBtn" class="btn btn-outline">ğŸ“ æŸ¥çœ‹æ­·å²</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById("camera");
  const overlay = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const historyBtn = document.getElementById("historyBtn");
  const patientId = new URLSearchParams(window.location.search).get("patient") || "unknown";

  // è§£æ±ºè¿”å›ä¸Šä¸€é ç›¸æ©Ÿé»‘ç•«é¢å•é¡Œ
  window.addEventListener("pageshow", function(event) {
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
      window.location.reload();
    }
  });

  // å•Ÿå‹•ç›¸æ©Ÿ
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => {
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => {
          video.play();
          resolve();
        };
      });
    })
    .catch(err => {
      Swal.fire("âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err.message, "error");
    });

  let capturedBlob = null;

  // æ‹ç…§ï¼ˆå« overlay ç–Šåœ–ï¼‰
  function captureImage() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
    return new Promise(resolve => {
      canvas.toBlob(blob => {
        capturedBlob = blob;
        resolve();
      }, "image/jpeg");
    });
  }

  // é»æ“Šæ‹ç…§ä¸¦ä¸Šå‚³
  captureBtn.addEventListener("click", async () => {
    await captureImage();
    Swal.fire({
      title: "ç¢ºå®šè¦ä¸Šå‚³é€™å¼µç…§ç‰‡å—ï¼Ÿ",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "ä¸Šå‚³",
      cancelButtonText: "å–æ¶ˆ"
    }).then(result => {
      if (result.isConfirmed && capturedBlob) {
        const formData = new FormData();
        formData.append("image", capturedBlob, "tongue.jpg");
        formData.append("patient_id", patientId);

        fetch("/upload", { method: "POST", body: formData })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              Swal.fire("âœ… ä¸Šå‚³æˆåŠŸ", "å³å°‡è·³è½‰è‡³å¥åº·ç´€éŒ„", "success").then(() => {
                window.location.href = `/history?patient=${patientId}`;
              });
            } else {
              Swal.fire("âŒ ä¸Šå‚³å¤±æ•—", data.error || "è«‹ç¨å¾Œå†è©¦", "error");
            }
          })
          .catch(err => {
            Swal.fire("âŒ éŒ¯èª¤", err.message, "error");
          });
      }
    });
  });

  // æŸ¥çœ‹æ­·å²
  historyBtn.addEventListener("click", () => {
    window.location.href = `/history?patient=${patientId}`;
  });
</script>
{% endblock %}
