<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>舌苔辨識相機</title>
  <style>
    body { margin:0; text-align:center; background:#f0f0f0; }
    video, canvas { max-width:100%; height:auto; border:1px solid #ccc; }
    #capture { font-size:1.2rem; padding:0.5rem 1rem; margin:1rem; }
    #patient_id { font-size:1rem; padding:0.3rem; }
  </style>
</head>
<body>
  <h2>舌苔辨識相機</h2>

  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <br>

  <input id="patient_id" placeholder="病患ID">
  <button id="capture">拍照</button>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          drawOverlay();
        });
      })
      .catch(err => alert("無法開啟相機: " + err));

    function drawOverlay() {
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      ctx.strokeStyle = 'pink';
      ctx.lineWidth = 3;

      // 舌頭輪廓（橢圓）
      const centerX = overlay.width / 2;
      const centerY = overlay.height * 0.65;
      const radiusX = overlay.width * 0.2;
      const radiusY = overlay.height * 0.25;

      ctx.beginPath();
      ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
      ctx.stroke();
    }

    document.getElementById('capture').onclick = () => {
      const patient_id = document.getElementById('patient_id').value.trim();
      if (!patient_id) {
        alert("❌ 請輸入病患ID");
        return;
      }

      const canvas = document.createElement('canvas');
      canvas.width = overlay.width;
      canvas.height = overlay.height;
      const cctx = canvas.getContext('2d');

      cctx.drawImage(video, 0, 0);
      cctx.drawImage(overlay, 0, 0);

      canvas.toBlob(blob => {
        const form = new FormData();
        form.append('image', blob, 'capture.jpg');
        form.append('patient_id', patient_id);

        fetch('/upload', { method: 'POST', body: form })
          .then(res => res.json())
          .then(data => {
            console.log(data);
            alert("✅ 上傳成功\n" + JSON.stringify(data, null, 2));
          })
          .catch(err => alert("❌ 上傳失敗: " + err));
      }, 'image/jpeg');
    };
  </script>
</body>
</html>
