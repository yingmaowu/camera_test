{% extends "base.html" %}
{% block title %}相機拍照{% endblock %}
{% block content %}
<div class="card">
  <h1>舌苔辨識相機</h1>
  <p class="muted">請對準舌頭於疊圖範圍內再拍攝，保持光線均勻。</p>

  <!-- 相機容器 -->
  <div id="videoWrapper" style="position:relative; width:100%; max-width:500px; margin:auto; overflow:hidden; aspect-ratio:3/4; background:black; border-radius:12px">
    <video id="video" autoplay playsinline muted style="width:150%; transform:translateX(-25%); object-fit:cover; border-radius:12px"></video>

    <!-- 疊圖（確保路徑正確） -->
    <img id="overlay" alt="overlay"
         src="{{ url_for('static', filename='overlay.png') }}"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none;">

    <!-- 拍照畫布（隱藏用來擷取） -->
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <!-- 病患ID輸入（若已有，保留你的既有表單） -->
  <div class="grid grid-2" style="margin-top:16px">
    <div>
      <label class="muted">病患 ID</label>
      <input class="input" id="patientId" placeholder="輸入病患 ID">
    </div>
    <div class="flex" style="align-items:flex-end">
      <button id="btn-start" class="btn">啟動相機</button>
      <button id="btn-stop" class="btn btn-outline">停止相機</button>
    </div>
  </div>

  <!-- 固定底部操作列：拍照 / 上傳 -->
  <div class="sticky-actions">
    <div class="flex center" style="justify-content:center">
      <button id="btn-capture" class="btn">📸 拍照</button>
      <button id="btn-upload" class="btn btn-outline">☁️ 上傳</button>
    </div>
  </div>

  <!-- 若你原本頁面還有其它區塊（例如分析結果即時顯示），請貼在這裡 -->
  {# 原 index.html 其它內容放這裡 #}
</div>
{% endblock %}
{% block scripts %}
<script>
  // 這裡僅保留常用 id，細部行為沿用你原本的 JS（如已存在請刪除這段）
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const btnStart = document.getElementById('btn-start');
  const btnStop = document.getElementById('btn-stop');
  const btnCap = document.getElementById('btn-capture');
  const btnUpload = document.getElementById('btn-upload');

  async function startCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
      video.srcObject = stream;
      showToast("相機已啟動","success");
    }catch(e){
      showToast("相機啟動失敗","error");
      console.error(e);
    }
  }
  function stopCamera(){
    const s = video.srcObject; if(!s) return;
    s.getTracks().forEach(t=>t.stop()); video.srcObject=null;
    showToast("相機已停止","info");
  }
  function capture(){
    const w = video.videoWidth, h = video.videoHeight;
    if(!w || !h){ showToast("相機尚未就緒","error"); return; }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    showToast("已拍照");
  }
  async function upload(){
    // 這裡保留鈎子，實際上傳沿用你既有的 fetch/表單提交
    try{
      showToast("上傳中…","info");
      // e.g. const blob = await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.9));
      // await fetch("/upload", {method:"POST", body: formData});
      showToast("上傳成功","success");
    }catch(e){
      console.error(e);
      showToast("上傳失敗","error");
    }
  }
  btnStart?.addEventListener('click', startCamera);
  btnStop?.addEventListener('click', stopCamera);
  btnCap?.addEventListener('click', capture);
  btnUpload?.addEventListener('click', upload);
</script>
{% endblock %}
