<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>拍攝照片</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>拍攝照片 - 病患 ID：{{ patient_id }}</h1>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="overlay">
        <!-- 舌頭九宮格輔助框 -->
    </div>
    <button id="captureBtn">拍照</button>
    <button id="retakeBtn" style="display:none;">重新拍攝</button>
    <button id="uploadBtn" style="display:none;">上傳並辨識</button>
    <form action="/" method="get">
        <button type="submit">返回功能選單</button>
    </form>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        let stream;

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(s => {
                stream = s;
                video.srcObject = stream;
            });

        captureBtn.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'inline';
            uploadBtn.style.display = 'inline';
        });

        retakeBtn.addEventListener('click', () => {
            captureBtn.style.display = 'inline';
            retakeBtn.style.display = 'none';
            uploadBtn.style.display = 'none';
        });

        uploadBtn.addEventListener('click', () => {
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('image', blob, 'photo.jpg');
                formData.append('patient_id', '{{ patient_id }}');
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        alert('上傳成功');
                    } else {
                        alert('上傳失敗');
                    }
                });
            }, 'image/jpeg');
        });
    </script>
</body>
</html>
